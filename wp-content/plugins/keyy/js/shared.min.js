var keyy_send_command_admin_ajax=function(e,t,n,o,i,y){i="undefined"==typeof i?30:i,o="undefined"==typeof o||o;var r={type:"POST",url:keyy.ajax_url,timeout:1e3*i,data:{action:"keyy_ajax",subaction:e,nonce:keyy.ajax_nonce,data:t},success:function(e){if(o){try{var t=JSON.parse(e)}catch(i){return console.log(i),console.log(e),void alert(keyy.error_unexpected_response)}"undefined"!=typeof n&&n(t)}else"undefined"!=typeof n&&n(e)},error:function(t,n,o){"function"==typeof y?y(t,n,o):(console.log("keyy_send_command ("+e+"): error: "+n+" ("+o+")"),console.log(t))}};jQuery.ajax(r)},js_date=new Date,keyy_connection_token_zero_time_at=Math.round(js_date.getTime()/1e3),keyy_login_token_zero_time_at=keyy_connection_token_zero_time_at;"undefined"!=typeof document.hidden&&document.addEventListener("visibilitychange",function(){Keyy.handle_page_visibility_change()},!1),jQuery(document).ready(function(e){if(Keyy=Keyy(keyy_send_command_admin_ajax),keyy.hasOwnProperty("connection_token")&&Keyy.set_connection_token(keyy.connection_token),Keyy.parse_query_string.keyy_token_id){var t={value:Keyy.parse_query_string.keyy_token_id,expires_after:285,origin:"autologin"};Keyy.parse_query_string.hasOwnProperty("keyy_password")&&"required"==Keyy.parse_query_string.keyy_password&&(t.password_policy="required",Keyy.parse_query_string.hasOwnProperty("keyy_user_login")&&(t.user_login=Keyy.parse_query_string.keyy_user_login)),Keyy.set_login_token(t)}else keyy.hasOwnProperty("login_token")&&Keyy.set_login_token(keyy.login_token);keyy.hasOwnProperty("connection_result")&&Keyy.set_connection_result(keyy.connection_result),keyy.hasOwnProperty("connected")&&Keyy.set_connection_status(keyy.connected),e("#keyy_connect_frontend_qrcode").length>0&&Keyy.setup_connection_code_area("#keyy-connect-frontend-container","#keyy_connect_frontend_qrcode","get_frontend_connection_code")});var Keyy=function(e){var t,n,o,i,y=jQuery,r=null,s=-1,a=keyy.context,c=1,_=null,l=null,d=null,u=null;this.parse_query_string=function(){for(var e={},t=window.location.search.substring(1),n=t.split("&"),o=n.length,i=0;i<o;i++){var y=n[i].split("=");if("undefined"==typeof e[y[0]])e[y[0]]=decodeURIComponent(y[1]);else if("string"==typeof e[y[0]]){var r=[e[y[0]],decodeURIComponent(y[1])];e[y[0]]=r}else e[y[0]].push(decodeURIComponent(y[1]))}return e}(),this.save_settings=function(t,n,o,i){i="undefined"==typeof i?"user":i,"undefined"!=typeof n&&y(n).show();var r=Keyy.gather_settings(t),s={type:i,data:r};"user-via-site-admin"==i&&(s.user_id=y(".keyy_user_settings").data("user_id")),e("save_settings",s,function(e){if("undefined"!=typeof n&&y(n).hide(),"undefined"!=typeof o&&y(o).show().delay(5e3).fadeOut(),e&&e.hasOwnProperty("errors")){for(var t=0,r=e.errors.length;t<r;t++){var s='<div class="error">'+e.errors[t]+"</div>",a=y("#keuy-admin-body-container").length>0?"#keyy-admin-body-container":y("#keyy-admin-settings").length>0?"#keyy-admin-settings":".keyy_user_settings_container";"user-via-site-admin"==i&&(a=".keyy_user_results .keyy-site-admin-user-settings"),Keyy.temporarily_display_notice(s,a)}console.log(e.errors)}})},this.gather_settings=function(e){var t=y(e+" input[name!='action'], "+e+" textarea, "+e+" select").serialize();return y.each(y(e+" input[type=checkbox]").filter(function(e){return 0==y(this).prop("checked")}),function(e,n){var o="0";t+="&"+y(n).attr("name")+"="+o}),t},this.temporarily_display_notice=function(e,t,n){t="undefined"==typeof t?"#keyy-admin-body-container":t,n="undefined"==typeof n?15:n,y(e).hide().prependTo(t).slideDown("slow").delay(1e3*n).slideUp("slow",function(){y(this).remove()})},this.stop_login_polling=function(){null!==u&&(clearTimeout(u),u=null)},this.set_connection_result=function(e){r=e},this.set_connection_status=function(e){s=e},this.get_connection_status=function(){return s},this.set_connection_token=function(e){t=e;var n=t.expires_after-5;n<1&&(n=1),null!==_&&clearTimeout(_),_=setTimeout(function(){_=null,y(".keyy_qrcode").html(keyy.replacing),Keyy.replace_connection_token()},1e3*n)},this.get_login_token=function(){return n},this.set_login_token=function(e){n=e;var t=n.expires_after-5;t<1&&(t=1),null!==l&&clearTimeout(l),l=setTimeout(function(){l=null,y(".keyy_qrcode").html(keyy.replacing),Keyy.replace_login_token()},1e3*t)},this.replace_connection_token=function(){e("get_connection_token",{force_refresh:1},function(e){if(e.hasOwnProperty("value")){var t=new Date;keyy_connection_token_zero_time_at=Math.round(t.getTime()/1e3),Keyy.set_connection_token(e),Keyy.show_keyy_code(".keyy_qrcode",a)}else!1!==e&&(console.log("Keyy: get_connection_token: unexpected result"),console.log(e))},!0,30,function(e,t,n){y(".keyy_qrcode").html(keyy.refresh),console.log(e)})},this.replace_login_token=function(){e("get_fresh_login_token",null,function(e){if(e.hasOwnProperty("value")){var t=new Date;keyy_login_token_zero_time_at=Math.round(t.getTime()/1e3),Keyy.set_login_token(e),Keyy.show_keyy_code(".keyy_qrcode",a)}else console.log("Keyy: get_fresh_login_token: unexpected result"),console.log(e)},!0,30,function(e,t,n){y(".keyy_qrcode").html(keyy.refresh),console.log(e)})},this.get_keyy_code_type=function(){return"undefined"==typeof i&&(i=keyy.use_wave?"wave":"qr"),i},this.set_keyy_code_type=function(e){i="wave"===e?"wave":"qr"},this.handle_page_visibility_change=function(){"hidden"==document.visibilityState?o=window.setTimeout(function(){c=0},1e4):(c=1,"undefined"!=typeof o&&window.clearTimeout(o))},this.poll_for_result=function(t,o,i){var i="undefined"==typeof i?10:i,y={};if(i>0&&(y.wait=i),"login"==t)y.token_id=n.value,e("get_token_state",y,function(e){if(e.hasOwnProperty("state")){if("undefined"!=typeof o){var t=o(e,n);t&&Keyy.stop_login_polling()}}else!1!==e&&(console.log("Keyy: get_token_state: unexpected result:"),console.log(e))});else{var a=s?"disconnect":"connect";r&&r.hasOwnProperty("time")&&(y.since_time=r.time),e("get_"+a+"ion_result",y,function(e){if(e&&e.hasOwnProperty("connection_token")&&Keyy.set_connection_token(e.connection_token),s)e.hasOwnProperty("connected")&&!e.connected&&(Keyy.set_connection_status(!1),"undefined"!=typeof o&&o(e));else{if(!e.hasOwnProperty("time"))return;if(r&&r.hasOwnProperty("time")&&e.time<=r.time)return;e.hasOwnProperty("connected")&&Keyy.set_connection_status(e.connected),Keyy.set_connection_result(e),"undefined"!=typeof o&&o(e)}})}};var f=function(e){if(e<=4)return{poll_for:6,next_poll_at:4};if(e<=30){var t=Math.max(6+e-e%6-1,11);return{poll_for:3,next_poll_at:t}}var t=6+e-e%6-1;return e<=120?{poll_for:2,next_poll_at:t}:{poll_for:0,next_poll_at:t}};return this.register_listener=function(e,t){var n,o=0;if("connect"==e)d=setInterval(function(){o++,n=f(o),o>=n.next_poll_at&&c&&Keyy.poll_for_result(e,t,n.poll_for)},1e3);else if("login"==e){if(u)return void(keyy.debug&&console.log("Keyy: login listener already active; will not set up another (presumably the page has multiple scan areas)"));u=setInterval(function(){o++,n=f(o),o>=n.next_poll_at&&c&&Keyy.poll_for_result(e,t,n.poll_for)},1e3)}},this.lazy_load_graphics=function(e){y(e).each(function(){"undefined"!=typeof y(this).attr("data-src")&&y(this).attr("src",y(this).attr("data-src"))})},this.exit_animation=function(){y("div.keyy_qrcode.keyy_wave_container").css("transition","all .8s ease-in-out"),y("div.keyy_qrcode.keyy_wave_container").css("transform","scale(.5)"),"wave"==Keyy.get_keyy_code_type()&&setTimeout(function(){y("rect").each(function(){y(this).on("animationiteration webkitAnimationIteration",function(){y(this).css("transition","all .8s ease-in-out"),y(this).removeClass("anim")})})},250);var e=y("svg.keyy-wave"),t=document.createElementNS("http://www.w3.org/2000/svg","circle");y(t).attr("cx","150"),y(t).attr("cy","100"),y(t).attr("r","200"),y(t).css({stroke:"#ec7f52",strokeWidth:"10px",fill:"none",animation:"encircle .9s linear alternate forwards","stroke-dasharray":"1329","stroke-dashoffset":"1329"}),y(e).append(t),"wave"==Keyy.get_keyy_code_type()?setTimeout(function(){y(".keyy-wave g").css("animation","rotateOut 500ms").fadeOut("slow")},1600):y(".keyy_qrcode.keyy_wave_container img").css("animation","rotateOut 500ms").fadeOut("slow").hide(),"wave"==Keyy.get_keyy_code_type()?setTimeout(function(){y(".keyy_qrcode.keyy_wave_container").prepend('<object class="keyy-thumbs-up" type="image/svg+xml" data="'+keyy.keyy_thumbs_up+'"></object>'),y(".keyy-thumbs-up").css("animation","rotateIn 200ms").fadeIn("fast")},1800):(y(".keyy_qrcode.keyy_wave_container img").replaceWith('<object class="keyy-thumbs-up" type="image/svg+xml" data="'+keyy.keyy_thumbs_up+'"></object>'),y(".keyy-thumbs-up").css("animation","rotateIn 200ms").css("left","40px").fadeIn("fast"))},this.render_keyy_code=function(e,t,o){if(y("#login").css("min-width","450px").css("padding-top","3%"),"wave"==o&&"login"==keyy.context){var i=keyy.site_hash+n.value;y(e).data("keyy_form_identifier")&&(i+=y(e).data("keyy_form_identifier")),console.log("Keyy Wave: "+i),y(e).addClass("keyy_wave_container").data("wave",i).empty().append('<svg class="keyy-wave"></svg>'),y(e).find(".keyy-wave").each(function(e){JsBarcode(this,i,{lineColor:keyy.wave_colour,width:2,height:180,displayValue:!1}),y(this).find("rect").each(function(){y(this).addClass("anim")}),y("rect.anim").each(function(){y(this).css("animation-duration",(.15*(4*Math.random()+5)).toString().substring(0,4)+"s")})})}else{console.log("Keyy: QR URL: "+t);var r=kjua({render:"image",text:t,ecLevel:"H",fill:"#da521b",crisp:!1});if(y(e).addClass("keyy_qrcode").data("qrcode",t).empty(),"string"==typeof e){var s=document.querySelector(e);s&&s.appendChild(r)}else y(e).append(r)}keyy.debug&&y(e).append('<div class="keyy-debug">'+t+"</div>")},this.show_keyy_code=function(o,i){i="undefined"==typeof i?"login":i,a=i;var r=keyy.qr_url+"?context="+i,s=new Date,c=Math.round(s.getTime()/1e3),_=c-keyy_connection_token_zero_time_at,l="connect"==i?t.expires_after:n.expires_after,d="connect"==i?"get_connection_token":"get_fresh_login_token",u="connect"==i?{force_refresh:1}:null;if(_+2>l)e(d,u,function(e){if(e.hasOwnProperty("value")){var s=new Date;"connect"==i?(keyy_connection_token_zero_time_at=Math.round(s.getTime()/1e3),Keyy.set_connection_token(e)):(keyy_login_token_zero_time_at=Math.round(s.getTime()/1e3),Keyy.set_login_token(e));var a="connect"==i?t:n;r=r+"&token="+a.value,y(o).each(function(e){if(y(this).data("keyy_form_identifier")){var t=r+"&form_id="+y(this).data("keyy_form_identifier");Keyy.render_keyy_code(this,t,Keyy.get_keyy_code_type())}else Keyy.render_keyy_code(this,r,Keyy.get_keyy_code_type())})}});else{var f="connect"==i?t:n;r=r+"&token="+f.value,y(o).each(function(e){if(y(this).data("keyy_form_identifier")){var t=r+"&form_id="+y(this).data("keyy_form_identifier");Keyy.render_keyy_code(this,t,Keyy.get_keyy_code_type())}else Keyy.render_keyy_code(this,r,Keyy.get_keyy_code_type())})}},this.setup_connection_code_area=function(t,n,o){Keyy.get_connection_status()||Keyy.show_keyy_code(n,"connect"),Keyy.register_listener("connect",function(i){if(console.log("Keyy: remote command received:"),console.log(i),!(i.hasOwnProperty("code")&&i.hasOwnProperty("data")&&i.data&&i.data.hasOwnProperty("message")))return void alert(keyy.error_unexpected_response);i&&i.hasOwnProperty("connection_token")&&Keyy.set_connection_token(i.connection_token);var r=(i.code,i.data.message);y(t).after('<div class="keyy_connected_message">'+r+"</div>"),e(o,null,function(e){e&&e.hasOwnProperty("html")?(y(t).fadeOut("slow",function(){y(this).replaceWith(e.html),y(n).length>0&&Keyy.show_keyy_code(n,"connect")}),setTimeout(function(){y(t).siblings(".keyy_connected_message").slideUp("slow",function(){y(this).remove()})},5e3)):(console.log("Keyy: "+o+" failed"),console.log(e))})})},this};